name: HealthOps MERN CI Pipeline

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  install-and-lint:
    name: Install, Lint, and Audit
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v3

      - name: ğŸ› ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: ğŸ“¦ Install backend dependencies
        run: npm ci
        working-directory: ./

      - name: ğŸ“¦ Install frontend dependencies
        run: npm ci
        working-directory: ./client

      - name: ğŸ” Lint backend
        run: npx eslint . --ext .js
        working-directory: ./

      - name: ğŸ” Lint frontend
        run: npx eslint src --ext .js,.jsx
        working-directory: ./client

      - name: ğŸ”’ Audit backend dependencies
        run: npm audit --audit-level=moderate || true
        working-directory: ./

      - name: ğŸ”’ Audit frontend dependencies
        run: npm audit --audit-level=moderate || true
        working-directory: ./client

  build-and-test:
    name: Build & Test
    runs-on: ubuntu-latest
    needs: install-and-lint

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v3

      - name: ğŸ› ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: ğŸ“¦ Install backend
        run: npm install
        working-directory: ./

      - name: ğŸ“¦ Install frontend
        run: npm install
        working-directory: ./client

      - name: ğŸ—ï¸ Build frontend
        run: npm run build
        working-directory: ./client

      - name: âœ… Dummy backend test
        run: echo "Backend tests coming soon..."

      - name: âœ… Dummy frontend test
        run: echo "Frontend tests coming soon..."

      - name: âœ… Confirm React built
        run: test -f ./client/build/index.html
